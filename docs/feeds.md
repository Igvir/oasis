# How Feeds Works

## What are Feeds?
Feeds in Oasis are notifications that received by end users about
their achievements in playing games. Feeds are generated by engine(s)
and those will be delivered in near real-time to the end users based on the 
configured mechanism. Feeds can take form of either push notifications or
web-socket events depending on the media used by the user.

### Example Feeds in Oasis
Basically, a game element can generate feeds if necessary, and by default,
all core elements will generate feeds.

* User scored points
* User rewards with a badge
* User achieves a milestone
* User won a challenge
* User's rating has been changed

## Feeds Delivery

The subscriptions will be automatically enabled for all users at the time of registration,
but users can choose themselves to opt out from those subscriptions as necessary.

![Feed Delivery](/docs/images/oasis-feeds.png?raw=true "Feeds Delivery")

As depicted in the image,
  1. Feeds will be generated by engine(s) and push them to the stream manager (default: kafka)
  2. The notification service will read those feed messages and optionally will correlate subscription details with admin database.
  3. And then, those notifications will be delivered via 3rd party messaging systems.

#### Feed Payload
A sample feed will consist of below information.

```json
{
  "byPlugin": "<plugin-id>",
  "eventType": "<type-of-feed>",
  "eventTimestamp": 1656921284867,
  "scope": {
    "gameId": 2893,
    "sourceId": 9328212,
    "userId": 7084328432473,
    "teamId": 2241
  },
  "data": {
    // ... payload depends on plugin and eventType
  }
  
}
```

| Field            | Type | Description                                                                                                                                           |                                                                                                                             
|------------------| ----- |-------------------------------------------------------------------------------------------------------------------------------------------------------|
| `byPlugin`       | string | Indicates which plugin generated this feed event. Default plguins: `core:point`, `core:badge`, `core:milestone`, `core:challenge`, and `core:rating`. |
| `eventType`      | string | Type of feed scoped to the plugin. Some plugins may emit different type of feed events. Based on the type, the content of `data` field may vary.      |
| `eventTimestamp` | number | Actual timestamp of this reward achieved. This will contain the timestamp of the caused event to generate the reward in epoch milliseconds.           |
| `scope`          | object | Scope object of this feed.                                                                                                                            |
| `scope.gameId`   | number | Game id this feed belongs to. This field will be there with every feed.                                                                               |
| `scope.userId`   | number | User id this feed belongs to.                                                                                                                         |
| `scope.teamId`   | number | Team id this user belongs to.                                                                                                                         |
| `scope.sourceId` | number | External source id of the event that caused to generated this feed.                                                                                   |
| `data`           | object | This field will contain the actual feed data depending on the plugin and its type.                                                                    |

##### Available Feed Types and their data payload by Plugin

| Plugin           | Type              | Data Payload                                                                                                                               |
|------------------|-------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| `core:point`     | POINT_SCORED      | { "ruleId": number, "pointsScored": number }                                                                                               |
| `core:badge`     | BADGE_EARNED      | { "ruleId": number, "attribute": number }                                                                                                  |
| `core:milestone` | MILESTONE_REACHED | { "ruleId": number, "currentLevel": number, "previousLevel": number }                                                                      |
| `core:challenge` | CHALLENGE_WON     | { "ruleId": number, "position": number }                                                                                                   |
| `core:challenge` | CHALLENGE_OVER    | { "ruleId": number, "reason": "\<string\>" }  <br><br>  The `reason` field can take two forms either `TIME_EXPIRED` or `ALL_WINNERS_FOUND` |
| `core:rating`    | RATING_CHANGED    | { "ruleId": number, "previousRating": number, "currentRating": number }                                                                    |


### Last-mile Delivery

Last mile feed delivery to actual end users will be done by well popular and stable existing 
messaging services, such as, [Amazon SNS](https://aws.amazon.com/sns), [PubNub](https://www.pubnub.com/), [Pusher](https://pusher.com/) etc.
Or you can integrate it with your existing notification infrastructure as you wish.

**Note**: Default notification service will provide the ability to configure which 
messaging service to be used at the deployment time. As a developer,
you need plan ahead in terms of which service to use, since in any case
if you want o switch to another provider. The reason is that, the app
or site the end-users using needs to be updated with new service along
with backend deployments.

## Feeds Subscription
As mentioned above, when a user is registered, a subscription will be created automatically.
Upon a subscription, a unique subscription id will be generated. 
And later at a time, user can opt out the subscription, so preventing user getting future 
notifications.

Guest users will not be eligible or receiving notifications.

### Subscription API

  * **GET** `/players/{playerId}/subscription`: Returns the subscription associate with the user. If no subscription exists, will return http code `404`.
  * **POST** `/players/{playerId}/subscription`: Creates a new subscription for the player. If such already exists, an error will be thrown since there can be one and only subscription per user.
  * **DELETE** `/players/{playerId}/subscription/{subscriptionId}`: Updates the existing subscription.

Resulting subscription object will contain below fields:
```json
{
  "playerId": 8329321093,   // provided player id
  "subscriptionId": "<subscription-id-as-string>",
  "subscriptionStatus": "ACTIVE", // possible values (ACTIVE/INACTIVE)
  "subscribedAt": 1635312245663   // when this subscription was created
}
```

## Integrate custom messaging service
If you want to integrate the messaging service as one of your preferred service,
you can do it by implementing the `FeedDeliverable` interface. Before that, you need
to add module `oasis-core` as a dependency to your project.

```java
import io.github.oasis.core.external.FeedDeliverable;

public class YourMessagingService implements FeedDeliverable {

    public void init(OasisConfigs configs) throws Exception {
        // initialize your messaging service
        // this will be called once the notification service starts
    }

    public void send(FeedEntry feedEntry) {
        // publish this feed entry to your messaging service
        // If any error occurred it should be silently handle
    }

    public void close() {
        // close you opened connections to the service
        // This will be called once when notification service is shutting down.
    }
} 
```

Then specify this implementation class in the configs of `notification-service.conf` file.

```
oasis {
  
  messaging {
    "impl": "io.github.oasis.ext.YourMessagingService"
    "configs": {
    
        // ... you can provide any custom configs as you need
        // and read them in the init() method.
        
    }
  }
  
  ... rest of configs
}
```

## Custom Notification Service
If you don't like using the provided notification service, you can stop
deploying it, and you can directly consume feed entries from stream manager (Kafka).
This allows more freedom to be used by your other internal applications.

